# Palantir AI Platform – Developer Guide

> Single Source of Truth for all contributors (updated 2025-06-08)

---

## 1. 프로젝트 개요 (Project Vision)
본 프로젝트는 Palantir Foundry / AIP 철학을 오픈소스 스택으로 재현하여, 온톨로지 기반 데이터 통합·실시간 파이프라인·AI 어시스트 기능을 단일 플랫폼에 제공합니다.

핵심 지향점
1. 하이브리드 저코드 + SDK 개발 모델
2. 온톨로지-중심 객체 / 링크 / 액션 패러다임
3. Kafka → Pipeline → VectorStore → LLM 실시간 루프
4. Self-Improving LoRA 미세조정 루프
5. 엔터프라이즈-급 DevOps & Observability

---
## 2. 시스템 아키텍처 (System Architecture)
아래 다이어그램은 `docker-compose.yml` 을 기반으로 자동 생성됩니다.

![System Architecture](./assets/system_architecture.png)

구성요소 요약
| Stack | 역할 |
|-------|------|
| FastAPI `api` | REST + WebSocket 백엔드 / LLM 라우팅 |
| Kafka & Zookeeper | 실시간 이벤트 버스 |
| PostgreSQL / SQLite | 메인 트랜잭션 DB |
| Weaviate | Vector Store (RAG) |
| Prometheus / Grafana | 모니터링 & 대시보드 |
| Loki | 로그 집계 |

---
## 3. 개발 & 배포
### 3.1 로컬 개발 환경 설정
```bash
# 의존성 설치 (Poetry)
poetry install --no-interaction --with dev
# 서비스 기동 (DB·Kafka·Grafana 등)
docker-compose up -d
# 백엔드 	
poetry run uvicorn main:app --reload
# Streamlit UI 예시
poetry run palantir run ui
```
### 3.2 프로덕션 배포
1. `docker-compose -f docker-compose.yml --profile prod up -d`  
2. Grafana → Import Dashboard json  
3. GitHub Actions 빌드된 Docker 이미지 `palantir:latest` 사용

---
## 4. 핵심 기능 & 코드 구조
| 기능 | 주요 모듈 |
|------|-----------|
| 실시간 스트리밍 → 파이프라인 | `palantir.ingest.kafka_consumer` → `palantir.core.pipeline` |
| 파이프라인 빌더 UI | `apps/reflex_ui/pipeline_ui/...` |
| LLM Ask / Feedback | `palantir/api/ask.py`, `palantir/core/llm_manager.py` |
| Self-Improve Loop | `scripts/run_finetuning.py`, `self_improve.py` |

---
## 5. UI 애플리케이션 (Presentation Layer)
| 디렉터리 | 프레임워크 | 상태 |
|-----------|-----------|------|
| `apps/streamlit_ui` | Streamlit | Stable – Chat, Data Explorer |
| `apps/reflex_ui` | Reflex + React-Flow | MVP – 파이프라인 Builder |

## 5.1 Reflex UI vs. Streamlit UI
현재 **apps/reflex_ui** 가 차세대 파이프라인 빌더·대시보드 기능을 제공하는 메인 UI입니다.  
`apps/streamlit_ui` 는 레거시 챗/데이터 탐색 인터페이스로 유지보수 모드에 있으며, 신규 기능은 Reflex UI에 먼저 반영됩니다.

실행 방법:
```bash
# Reflex UI (권장)
poetry run reflex run --app apps.reflex_ui.pipeline_ui.pipeline_ui:app

# 기존 Streamlit UI (deprecated)
poetry run streamlit run apps/streamlit_ui/main.py
```

---
## 5.2 Kafka Ingestion Flow
`palantir.ingest.kafka_consumer.consume_messages` 가 Kafka 토픽 **raw-data-stream** 을 구독하여 실시간 JSON 이벤트를 파이프라인으로 전달합니다.

설정 값은 `docker-compose.yml` 의 `kafka` 서비스와 일치해야 하며, 토픽/브로커는 `palantir/core/settings.py` 에서 오버라이드할 수 있습니다.

---
## 5.3 Self-Improve Loop
`self_improve.py` 는 매일 03:00(WSL Cron) 품질 게이트(ruff/black/pytest/benchmark 등)를 실행하고 실패 시 `logs/error_report_*.md` 를 생성합니다.

파이프라인:
1. **테스트 & 린트** – 코드베이스 일관성 확보
2. **Radon, Mutmut** – 복잡도·뮤테이션 테스트 메트릭 수집
3. **Prometheus Export** – `/metrics/self_improve` 로 결과 노출

실행: `poetry run python self_improve.py`

---
## 6. API 명세 (API Reference)
FastAPI OpenAPI 스펙은 런타임에 `/openapi.json` 으로 제공됩니다.  
주요 엔드포인트 요약:
* `GET /status` – 헬스체크
* `POST /ask` / `POST /ask/feedback`
* `POST /pipeline/{validate|submit|visual}`

자세한 필드 설명은 Swagger UI (http://localhost:8000/docs) 참고.

---
## 7. 운영 & 모니터링 (Operations)
* Grafana 로그인 : `admin / $GRAFANA_ADMIN_PASSWORD`  
* 주요 대시보드 : API Latency, Kafka Lag, Self-Improve Metrics
* 문제 해결 Cheat-Sheet : `docs/troubleshooting.md` 내용 통합
  * 포트 충돌 → `docker ps` 후 컨테이너 정리
  * JWT 오류 → `users` 테이블 확인

---
## 8. 기여하기 (Contributing)
1. **브랜치 전략** : main (protected) / feat-/fix- 토픽 브랜치
2. **Lint & Test** : `make wsl-check && poetry run pytest -q`
3. **커밋 규칙** : Conventional Commits (`feat:`, `fix:` …)
4. **PR 체크리스트** : Test OK · CI green · 문서 업데이트

---
## 9. 유용한 스크립트 (Automation Scripts)
| 스크립트 | 설명 | 예시 |
|-----------|------|------|
| `scripts/run_finetuning.py` | 긍정 피드백(`llm_feedback`) 데이터로 LoRA 미세조정 실행 | `poetry run python scripts/run_finetuning.py` |
| `scripts/generate_architecture_diagram.py` | docker-compose.yml 파싱 → `docs/assets/system_architecture.png` 생성 | CI 워크플로에서 자동 호출 |
| `scripts/update_ci.py` | GitHub Actions 워크플로 파일을 코드에서 업데이트 | `python scripts/update_ci.py` |
| `scripts/gen_missing_tests.py` | 누락된 테스트 스텁 자동 생성 | `python scripts/gen_missing_tests.py palantir/` |

> 모든 스크립트는 `poetry run` 컨텍스트에서 실행할 것을 권장합니다.

---
> Generated by AI Agent – Docs as Code 